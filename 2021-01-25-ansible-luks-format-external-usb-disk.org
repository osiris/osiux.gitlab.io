#+TITLE:       ansible luks format external usb disk
#+DESCRIPTION: Cómo formatear y cifrar un disco externo usb con LUKS usando el rol de Ansible gcoop-libre.luks
#+AUTHOR:      Osiris Alejandro Gómez
#+EMAIL:       osiux@osiux.com
#+LANGUAGE:    es
#+LINK_HOME:   index.html
#+INCLUDE:     header.org
#+DATE:        2021-01-25 17:50
#+KEYWORDS:    Ansible, AnsibleRole, Backup, Crypt, CryptSetup, Disk, LUKS, LuksFormat, Pass, PasswordStore, Privacy, Restore, USB
#+HTML_HEAD:   <meta property="og:title" content="ansible luks format external usb disk" />
#+HTML_HEAD:   <meta property="og:type" content="article" />
#+HTML_HEAD:   <meta property="og:article:published_time" content="2021-01-25" />
#+HTML_HEAD:   <meta property="og:article:author" content="Osiris Alejandro Gómez" />
#+HTML_HEAD:   <meta property="og:url" content="https://osiux.com/2021-01-25-ansible-luks-format-external-usb-disk.html" />
#+HTML_HEAD:   <meta property="og:site_name" content="OSiUX" />
#+HTML_HEAD:   <meta property="og:locale" content="es_AR" />
#+HTML_HEAD:   <meta property="og:image" content="https://osiux.com/img/ansible-role-gcoop-libre-luks.png" />

[[file:img/ansible-role-gcoop-libre-luks.png][file:tmb/ansible-role-gcoop-libre-luks.png]]

** Empezamos mal!

Hoy es mi primer día de laburo del 2021 y arranqué mal, mi querida
_cachaza_ (una notebook _ASUS Q324UAK_) se apagó 3 veces en menos de
2hs de laburo, aparentemente por alto consumo de _CPU/IO_ y dado el
calor reinante, todo me lleva a pensar que es un problema de
temperatura, seguramente una limpieza le vendría bien, después de casi
4 años de funcionamiento interrumpido!

** Hay Backup?

Si bien ya conseguí un destornillador de esos muy precisos y logré
quitar los 10 tornillos _tork_, antes de terminar de desarmarla, recordé
que **NO tengo un backup completo y actualizado!**

Asi que, con ayuda expeditiva, me hice de un disco externo usb 3.0 de
4TB (aunque internamente tiene un poco bastante menos), pero _OjO_ antes
de copiar algo, esta el temita del cifrado de disco, es mi sana y
paranoica costumbre, cifrar los discos antes de comenzar a usarlos :)

** Automatizando la Paranoia!

De casualidad, recordé que tengo un rol de Ansible que nunca publiqué
justo en este disco, si ese que no se cuánto va a seguir funcionando en
la notebook que se apaga todo el tiempo (al menos hoy) y seguramente
además no debo tener copia alguna del rol...

Con unos muy pocos cambios logré cifrar el nuevo disco externo usando el
rol que en algún momento pensé y desarrollé, al cual solo le falta pulir
un poco, pero que en muy pocos pasos ya me resolvió la tarea!

** Tres pasos son... y no hay más...

1. Conectar el disco y detectar su =id=:

#+BEGIN_EXAMPLE

ls -1 /dev/disk/by-id/ | grep sdb1
usb-WD_Elements_1234_567890123456789012345678-0:0-part1 ⇒ ../../sdb1

#+END_EXAMPLE

2. Definir la variable =gcoop_luks_devices=:

#+BEGIN_SRC yaml :exports code

gcoop_luks_devices:
  - dev:  '/dev/sdb1'
    pass: "{{ lookup('pass', 'luks/' + ansible_hostname + '/' + 'usb-WD_Elements_1234_567890123456789012345678-0:0-part1' + gcoop_luks_pass_opts ) }}"
    name: 'data'

#+END_SRC

3. Ejecutar el rol =gcoop-libre.luks=:

#+BEGIN_EXAMPLE

# make
ANSIBLE_PASS_PASSWORD_STORE_DIR=$HOME/.password-store ansible-playbook  -i tests/inventory tests/test.yml

PLAY [test] ***********************************************************

TASK [Gathering Facts] ************************************************
ok: [cachaza]

TASK [gcoop-libre.luks : install cryptsetup] **************************
ok: [cachaza]

TASK [gcoop-libre.luks : verify is exists /dev/sdb1] ******************
ok: [cachaza]

TASK [gcoop-libre.luks : create /root/tmpfs] **************************
changed: [cachaza]

TASK [gcoop-libre.luks : unmount /root/tmpfs] *************************
ok: [cachaza]

TASK [gcoop-libre.luks : mount /root/tmpfs] ***************************
changed: [cachaza]

TASK [gcoop-libre.luks : write keyfile] *******************************
changed: [cachaza]

TASK [gcoop-libre.luks : stat] ****************************************
ok: [cachaza]

TASK [gcoop-libre.luks : luksFormat /dev/sdb1] ************************
changed: [cachaza]

TASK [gcoop-libre.luks : verify isOpen /dev/sdb1] *********************
ok: [cachaza]

TASK [gcoop-libre.luks : luksOpen /dev/sdb1] **************************
skipping: [cachaza]

TASK [gcoop-libre.luks : wipe /root/tmpfs/keyfile] ********************
changed: [cachaza]

TASK [gcoop-libre.luks : unmount "/root/tmpfs"] ***********************
changed: [cachaza]

TASK [gcoop-libre.luks : delete /root/tmpfs] **************************
changed: [cachaza]

PLAY RECAP ************************************************************
cachaza                : ok=14   changed=7    unreachable=0
                         failed=0    skipped=1    rescued=0    ignored=0

#+END_EXAMPLE

** liberando =gcoop.luks=

Solo falta un pequeño _refactor_ para pulir y poder liberar el rol.

...continuará...

** tal vez te interese leer...

- [[file:2023-05-26-ansible2dot-hp-linux-tools.org][=ansible2dot= /HP Linux Tools/]]
- [[file:2022-10-20-como-migrar-6300-equipos-a-gnu-linux-usando-ansible-y-awx.org][Cómo migrar 6300 equipos a GNU/Linux usando Ansible y AWX]]
- [[file:2022-10-08-automate-deployment-of-AWX-resources-with-GitLab-CI-CD-and-ansible-tools.org][Automatizar la implementación de los recursos de AWX con GitLab CI/CD y Ansible Tools]]
- [[file:2022-10-03-ansible-tools-v0-3-0.org][/Ansible Tools/ =v0.3.0=]]
- [[file:2021-12-30-automated-bios-configuration-using-ansible-and-hp-linux-tools.org][Automatizar la configuración de la /BIOS/ usando =ansible= y /HP Linux Tools/]]



** ChangeLog

  - [[https://gitlab.com/osiux/osiux.gitlab.io/-/commit/43331c9ab597166c76d0d75496541311710585fd][=2023-06-05 17:35=]] agregar DESCRIPTION, KEYWORDS, imagen y links a /ansible luks format external usb disk/
  - [[https://gitlab.com/osiux/osiux.gitlab.io/-/commit/bf3a61526ad2a73cecb77a18995f1d63494e3664][=2022-11-13 20:39=]] agregar y actualizar tags OpenGraph
  - [[https://gitlab.com/osiux/osiux.gitlab.io/-/commit/cba3fbb8e53a493c6d672381bb08b8dd5ff73fe8][=2021-01-25 18:16=]] add 2021-01-25-ansible-luks-format-external-usb-disk.org
